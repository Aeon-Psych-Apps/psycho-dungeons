name: Build Tines Patch JSON & Update Changelog

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to run the workflow on'
        required: true
        default: 'test'

jobs:
  build_patch:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.inputs.branch }}

      - name: Verify branch
        run: |
          if [ "${{ github.event.inputs.branch }}" != "test" ] && [ "${{ github.event.inputs.branch }}" != "main" ]; then
            echo "Workflow only runs for the test or main branch."
            exit 0
          fi

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install python-magic pytz

      - name: Generate latest.json (and versioned JSON if on main with tag)
        run: |
          python - <<'EOF'
          import os, json, base64, mimetypes

          config_file = 'config/config.json'
          scripts_dir = 'scripts'
          images_dir = 'images'
          manual_dir = 'manual'

          with open(config_file, 'r', encoding='utf-8') as f:
              config = json.load(f)

          scripts = []
          for file in os.listdir(scripts_dir):
              if file.endswith('.py'):
                  name_only = os.path.splitext(file)[0]
                  with open(os.path.join(scripts_dir, file), 'r', encoding='utf-8') as f:
                      scripts.append({"name": name_only, "contents": f.read()})

          manual = []
          for file in os.listdir(manual_dir):
              if file.endswith('.md'):
                  name_only = os.path.splitext(file)[0]
                  with open(os.path.join(manual_dir, file), 'r', encoding='utf-8') as f:
                      manual.append({"name": name_only, "contents": f.read()})

          images = []
          for file in os.listdir(images_dir):
              path = os.path.join(images_dir, file)
              mime_type, _ = mimetypes.guess_type(path)
              if not mime_type:
                  mime_type = 'application/octet-stream'
              with open(path, 'rb') as f:
                  b64 = base64.b64encode(f.read()).decode('utf-8')
              images.append({"name": file, "type": mime_type, "contents": b64, "display_logo": True})

          patch_json = {"config": config, "scripts": scripts, "images": images, "manual": manual}

          os.makedirs('releases', exist_ok=True)
          with open('latest.json', 'w', encoding='utf-8') as f:
              json.dump(patch_json, f, indent=2)

          # Only create versioned JSON if running on main with a tag
          tag = os.environ.get('GITHUB_REF', '')
          if os.environ.get('GITHUB_REF_NAME') and tag.startswith('refs/tags/') and os.environ.get('GITHUB_REF_NAME') == os.environ.get('GITHUB_REF'):
              version = tag.replace('refs/tags/', '')
              with open(f'releases/{version}.json', 'w', encoding='utf-8') as f:
                  json.dump(patch_json, f, indent=2)
          EOF

      - name: Debug commits on branch
        run: |
          TZ="America/Phoenix"
          DATE=$(TZ=$TZ date +"%m/%d/%Y %H:%M %Z")
          echo "Phoenix timestamp: $DATE"

          echo "=== Full commit log for debugging ==="
          git log --no-merges --pretty=format:"%H %s%n%b%n---"

      - name: Update CHANGELOG.md & patch_notes.md
        run: |
          TZ="America/Phoenix"
          DATE=$(TZ=$TZ date +"%m/%d/%Y %H:%M %Z")
          echo "Phoenix timestamp: $DATE"

          # Process commits and categorize
          COMMITS=$(git log --no-merges --pretty=format:"%s%n%b%n---" | awk '
            BEGIN { RS="\n---\n"; FS="\n"; ORS=""; features=""; fixes=""; patches=""; misc=""; }
            {
              subject=$1;
              body="";
              if(NF>1){ for(i=2;i<=NF;i++){ if($i!="") body=body"    - "$i"\n"; } }

              # Skip internal/changelog commits
              lc_subject=tolower(subject);
              if(lc_subject ~ /^internal:/) next;
              if(lc_subject ~ /^update changelog/ || lc_subject ~ /^create patch_notes/ || lc_subject ~ /\[skip ci\]/) next;

              # Strip prefixes and categorize
              entry="";
              if(lc_subject ~ /^feature:/){
                sub(/^feature:[ ]*/i,"",subject); entry=subject "\n" body; features=features entry "\n";
              } else if(lc_subject ~ /^fix:/){
                sub(/^fix:[ ]*/i,"",subject); entry=subject "\n" body; fixes=fixes entry "\n";
              } else if(lc_subject ~ /^patch:/){
                sub(/^patch:[ ]*/i,"",subject); entry=subject "\n" body; patches=patches entry "\n";
              } else {
                entry=subject "\n" body; misc=misc entry "\n";
              }
            }
            END {
              if(features!="") print "### Features\n" features "\n";
              if(fixes!="") print "### Fixes\n" fixes "\n";
              if(patches!="") print "### Patches\n" patches "\n";
              if(misc!="") print "### Misc\n" misc "\n";
            }
          ')

          echo "=== Processed changelog output ==="
          echo "$COMMITS"

          # Write to CHANGELOG.md
          {
            echo "[$DATE]"
            echo ""
            echo "$COMMITS"
          } > CHANGELOG.md

          mkdir -p manual
          if [ ! -f manual/patch_notes.md ]; then
            echo "# Patch Notes" > manual/patch_notes.md
          fi

          # Prepend new changelog to patch_notes
          cat CHANGELOG.md manual/patch_notes.md > manual/tmp_patch_notes.md
          mv manual/tmp_patch_notes.md manual/patch_notes.md
          echo "" >> manual/patch_notes.md

          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git add CHANGELOG.md manual/patch_notes.md latest.json
          git add releases/*.json 2>/dev/null || true

          if ! git diff --cached --quiet; then
            git commit -m "Update CHANGELOG & patch_notes for $DATE [skip ci]"
            git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          else
            echo "No changes to commit"
          fi
